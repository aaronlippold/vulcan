<div class="row">
    <div class="col-lg-12">
        <div class="card-box">
            <h4 class="m-t-0 header-title"><%= @project.name %> Controls</h4>
            <table id="project-controls-datatable" class="table table-striped table-bordered toggle-circle m-b-0" data-page-size="7">
                <thead>
                    <tr>
                        <th>Applicability</th>
                        <th>Title</th>
                        <th>Impact </th>
                        <th>Nist Families</th>
                    </tr>
                </thead>
                <div class="form-inline m-b-20">
                    <div class="row">
                        <div class="col-md-6 text-center text-right">
                            <input id="project-controls-search" type="text" placeholder="Search" class="form-control" autocomplete="on">
                        </div>
                    </div>
                </div>
                <tbody>
                    <% @project.project_controls.each do |project_control| %>
                      <tr value="<%= project_control.id %>">
                          <% if project_control.status.nil? %>
                             <td><button class="btn btn-warning" >Not Set Yet</button></td>
                          <% elsif project_control.status == 'Not Applicable' %>
                             <td><button class="btn btn-primary" >Not Applicable</button></td>
                          <% elsif project_control.status == 'Applicable - Configurable' %>
                             <td><button class="btn btn-success" >Applicable - Configurable</button></td>
                          <% elsif project_control.status == 'Applicable - Does Not Meet' %>
                             <td><button class="btn btn-danger" >Applicable - Does Not Meet</button></td>
                          <% elsif project_control.status == 'Applicable - Inherently Meets' %>
                             <td><button class="btn btn-danger" >Applicable - Inherently Meets</button></td>
                          <% end %>
                          <td><%= project_control.title %></td>
                          <td><%= project_control.impact %></td>
                          <td><%= project_control.nist_controls.collect {|nist| nist.family + '-' + nist.index } %></td>
                      </tr>
                    <% end %>
                </tbody>
                <tfoot>
                  <tr class="active">
                      <td colspan="4">
                          <div class="text-right">
                              <ul class="pagination pagination-split justify-content-end footable-pagination m-t-10 m-b-0"></ul>
                          </div>
                      </td>
                  </tr>
                </tfoot>
            </table>
        </div>
        <%= link_to 'Back', projects_path %>
    </div>
</div>

<script>

// Add event listener for opening and closing details
$('#project-controls-datatable tr').on('click', function () {
  control_id = $(this).closest('tr').attr('value');
  url = '/project_controls/' + control_id + '.json';
  $.ajax({
    url: url,
    type: "get",
    datatype: 'json',
    success: function(data) {
      var table = $('#project-controls-datatable');
      var tr = $(this).closest('tr');
      console.log(details_panel(data));
      tr.append(details_panel(data)).show();
      
      
      // if ( row.child.isShown() ) {
      //   row.child.hide();
      //   tr.removeClass('shown');
      // } else {
      //    if ( table.row( '.shown' ).length ) {
      //       $('.table_row', table.row( '.shown' ).node()).click();
      //    }
      //    row.child( details_panel(data)).show();
      // }
    },
    error: function() {
      console.log("Error occured");
    }   
  });
});

  function details_panel ( d ) {
    // 'd' is the original data object for the row
  var details_panel = '';
  details_panel +=
  '<ul class="nav nav-tabs">'+
    '<li><a data-toggle="tab" href="#details" >Details</a></li>'+
    '<li><a data-toggle="tab" href="#inspec_code">Inspec Code</a></li>'+
  '</ul>'+
  '<div class="tab-content">'+
    '<div id="details" class="tab-pane">'+
      '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';


    //Mandatory feilds
    details_panel += '<tr>'+ '<td>Control:</td>'+ '<td>'+d['control_id']    +'</td>'+ '</tr>';
    details_panel += '<tr>'+ '<td>Title:</td>'  + '<td>'+d['title']  +'</td>'+ '</tr>';
    details_panel += '<tr>'+ '<td>Desc:</td>'   + '<td>'+d['description']+'</td>'+ '</tr>';

    var  DATA_NOT_FOUND_MESSAGE = 'N/A'
    // Optional Tags
    if (d['status']        != DATA_NOT_FOUND_MESSAGE) { details_panel += '<tr>'+ '<td>Status:</td>'    + '<td>'+d['status']             +'</td>'+ '</tr>'; }
    if (d['impact']        != DATA_NOT_FOUND_MESSAGE) { details_panel += '<tr>'+ '<td>Impact:</td>'    + '<td>'+d['impact']             +'</td>'+ '</tr>'; }
    if (d['check_content'] != DATA_NOT_FOUND_MESSAGE) { details_panel += '<tr class="overflow-wrap">'+ '<td>Check Text:</td>'+ '<td>'+d['checktext']+'</td>'+ '</tr>'; }
    if (d['fix_text']      != DATA_NOT_FOUND_MESSAGE) { details_panel += '<tr>'+ '<td>Fix Text:</td>'  + '<td>'+d['fixtext']           +'</td>'+ '</tr>'; }
    if (d['justification'] != DATA_NOT_FOUND_MESSAGE) { details_panel += '<tr>'+ '<td>Justification:</td>'  + '<td>'+d['justification'] +'</td>'+ '</tr>'; }


    details_panel +=
      '</table>'+
    '</div>'+
    '<div id="inspec_code" class="tab-pane">'+
      '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
        '<tr>'+
            '<td><pre id="precode" class="line-numbers"><code id="code" class="language-ruby">'+d.code+'</code></pre></td>'+
        '</tr>'+
      '</table>'+
    '</div>' +
  '</div>';

  return details_panel;
}
</script>
